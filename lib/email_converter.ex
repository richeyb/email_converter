defmodule EmailConverter do
  import EmailConverter.EmailWrapper, only: [build_email: 3]
  alias EmailConverter.GreenhouseIo

  def run do
    Application.ensure_all_started(:email_converter)
    Application.get_env(:email_converter, :api_key)
    |> convert()
  end

  # PRIVATE FUNCTIONS

  defp ids do
    [
      29474834, 29320204, 29416203, 29362817, 29241914, 29284803, 29217293, 28215223, 28652220, 29458632,
      29409096, 29393394, 29230142, 29498463, 29394570, 29493646, 28731314, 29379175, 28560127, 28653750,
      28653801, 29379663, 28721035, 29340184, 29340985, 29350955, 29247442, 28542201, 28744267, 29327218,
      28425812, 29367547, 28369564, 29269485, 29249213, 28851178, 29044666, 28957092, 28957092, 28839349,
      28900428, 28935029, 28816985, 29059394, 29181236, 29097394, 29009423, 28891150, 28891150, 29195359,
      28855973, 28926648, 29170181, 28415114, 27924159, 9536759, 25847902, 28683877, 27989984, 28131500,
      28315195, 26083385, 26285516, 27219230, 28559719, 24641629, 27998584, 25524030, 28550240, 27731659,
      28179779, 27743232, 7483533, 28710131, 28575266, 21049789, 27504364, 3370940, 28369056, 28453415,
      28552199, 27560569, 28365730, 28688399, 28107923, 27902647, 28756045, 27838111, 28188184, 28118623,
      28119399, 27767316, 12283627, 9063629, 9145208, 27769474, 26167255, 28333756, 27770345, 28704437,
      27585274, 28693185, 27716019, 28748891, 12825966, 29236478, 28582362, 28160482, 28577016, 29471165,
      28772321, 28493657, 28857209, 29197410, 29226616, 28950408, 29333370, 29306915, 29114045, 28785404,
      29392197, 29408547, 29126895, 29027088, 28930350, 28930350, 29230805, 28787204, 29288781, 29149288,
      28860746, 29175499, 29079489, 29232754, 29380628, 29042910, 29042969, 29029293, 29016679, 29105410,
      29117763, 28813499, 29383498, 28734566, 28185806, 28327580, 28231282, 28768579, 28231892, 28691131,
      28680329, 28252447, 28336564, 29375188, 29075638, 29211131, 28974234, 29448188, 29471935, 29025216,
      28963198, 29126718, 28822321, 29389265, 29147954, 29268830, 29320208, 29282023, 28859795, 29284803,
      29463675, 29357351, 29458632, 29014508, 29336634, 29175441, 29129316, 29426426, 28800057, 28849773,
      29092344, 28932304, 29004755, 29151482, 29203555, 29365289, 29117781, 29177173, 28992879, 29382287,
      29237370, 29230252, 9469819, 29107677, 29019400, 27672165, 24863952, 26273123, 26273123, 27930068,
      28958401, 6970404, 25059086, 25059086, 29021325, 25467200, 26285516, 29035153, 27998584, 29035346,
      29234483, 26749861, 29010490, 29062252, 29062252, 28949503, 28949579, 14473675, 27748298, 21049789,
      28673047, 25898689, 28683423, 28311404, 28278954, 28422829, 28568678, 28785404, 28314427, 15588287,
      27902438, 27902647, 28569244, 28652490, 28249657, 28065996, 27459655, 27839388, 22809192, 22811453,
      27908830, 28653801, 28118324, 26560656, 10376316, 28119399, 28119399, 28765881, 28765881, 28744267,
      12512424, 28425812, 25764037, 28289619, 9314807, 29329210, 28482562, 28734454, 28815427, 28815427,
      29107093, 29154240, 28853288, 29193322, 29096198, 29155025, 29096322, 29096853, 29097251, 29247442,
      28973577, 28127216, 28661133, 28547941, 6958524, 27989984, 13381156, 28248657, 9974700, 26437871,
      28422779, 26285516, 24640408, 28631694, 28157185, 27729301, 27424066, 28569244, 27608787, 27554172,
      4926073, 28743238, 28571650, 7736162, 21049789, 28765881, 28644797, 27692996, 28499496, 28744267,
      28699870, 11098740, 27694023, 28688152, 26978621, 27560569, 28365734, 8255674, 27561676, 28107923,
      28228687, 22410245, 28734922, 25434438, 27460156, 28735215, 16128592, 28502732, 28668520, 19982580,
      6016802, 28691131, 28192838, 27764834, 27398361, 28119399, 10433947, 28080907, 25864976, 28465091,
      28715423, 28638666, 24428063, 26016732, 28771598, 27667546, 28738886, 29453508, 28716663, 29280876,
      29382998, 28716971, 29161967, 29210873, 29102819, 29490576, 28974250, 29112950, 29184326, 29425666,
      29076457, 28963138, 29268948, 29147367, 29160399, 29147883, 28963883, 29358916, 29238653, 29257397,
      29393701, 29362817, 28953553, 29461828, 28811232, 29201587, 29445133, 29028698, 29457557, 28943060,
      29397253, 29029293, 29502943, 29389727, 29043282, 29511672, 29151620, 28767256, 28284904, 28326031,
      28459018, 28544214, 28564218, 28488726, 28575266, 28267883, 28770283, 28794213, 28771598, 28438943,
      28567053, 29051231, 29012187, 24865780, 29012630, 28033625, 13338399, 29225329, 25059086, 28940132,
      29013116, 26189494, 26890637, 29064864, 29147883, 29238681, 29200075, 25322400, 27545666, 28834811,
      28178055, 27422399, 27547297, 28044546, 29162235, 29079290, 29003689, 29202110, 28942688, 27610721,
      29202327, 28991451, 20906768, 27692996, 27454614, 29069226, 29257361, 28107923, 22162697, 29106691,
      28863641, 29107140, 20381598, 27458468, 29153351, 29230805, 29192307, 19982580, 6016802, 29179928,
      22862942, 29194563, 29181373, 29181373, 28829983, 29085156, 28197258, 28948296, 28972196, 28160482,
      24445703, 27714956, 12685023, 28926942, 29380195, 28961645, 28441952, 29403014, 28784476, 29470495,
      29404093, 29334148, 28314892, 28785631, 29454196, 29516770, 29403097, 29469852, 29376093, 29351358,
      29516570, 28786461, 29269613, 28730941, 28686038, 28570235, 29394423, 28643312, 28653801, 28560445,
      28558562, 28710131, 28710131, 29423520, 29404081, 29506650, 29327667, 28688399, 26164020, 29175499,
      24024648, 28943060, 12656335, 28920948, 27714956, 29176953, 27559118, 27692996, 29242992, 29272046,
      29107677, 28839726, 29258606, 28935029, 28935029, 29032898, 28876647, 29259758, 28865976, 29181236,
      29110059, 29122439, 27501834, 29123160, 29035712, 29010368, 29182815, 29062495, 29062793, 28973577,
      28973577, 29385893, 29303032, 28277929, 28279023, 29400203, 29405626, 29422369, 28730364, 29457908,
      29432089, 29422369, 29325926, 28559780, 29337305, 28560127, 29425857, 29389263, 29410599, 28698507,
      28368027, 29445806, 28499162, 28825318, 28744022, 28582404, 27688244, 28453777, 28813574, 29333857,
      26295747, 28734013, 27672165, 24865780, 24903714, 27219230, 27540999, 28544214, 26076349, 27934447,
      27676501, 28584905, 25282622, 28564662, 28320523, 28377415, 28703459, 28249544, 27289674, 28045703,
      27293054, 28335012, 28805645, 26209537, 26381031, 28304839, 27433000, 28511151, 29210843, 29251096,
      29101126, 28716899, 29199497, 28963883, 22787609, 28870943, 29014508, 16813717, 29041617, 27633021,
      29184326, 29027949, 29090999, 28785404, 29334504, 28718763, 29305409, 29457908, 29301427, 29363238,
      29461828, 29380628, 28836503, 29326618, 28777066, 28732911, 29504776, 28453777, 28552199, 28583002,
      28734672, 28690435, 28327949, 28827712, 28827943, 28504761, 28758526, 28627042, 28727824, 28793251,
      29249747, 27478895, 27479370, 29012183, 28893674, 24863952, 29159762, 29126511, 28881530, 26436917,
      29265522, 28248657, 29174071, 10182102, 29077984, 29014440, 27995645, 28941606, 29491385, 28175827,
      28691029, 28326031, 29042235, 28286300, 29202110, 28836503, 27554172, 29338686, 26383433, 26755860,
      26383433, 28873026, 27500221, 29269138, 28222881, 27433188, 29496142, 29450942, 28315195, 27692996,
      27692996, 27692996, 8075429, 27560365, 29093693, 29093693, 3453349, 28107923, 27835951, 29258606,
      29082956, 29108435, 28958401, 29179928, 28912001, 27462702, 27972041, 29008284, 28192838, 23130947,
      29097251, 6226906, 29181450, 28959782, 29097394, 29182034, 29248014, 29261934, 25862767, 29062252,
      29074409, 26170363, 12685023, 12685023, 29062778, 29432736, 29381578, 28512031, 28706990, 28417279,
      29282954, 29435470, 28831351, 29086843, 29170801, 29171041, 28547281, 28973577, 29263247, 28677849,
      29117763, 28127216, 29301864, 27219230, 29334731, 29405637, 27219230, 29365215, 29029212, 28575266,
      24903714, 27989984, 29197882, 28560445, 28314973, 29041578, 29362817, 27809037, 29444885, 29436532,
      26377716, 29088478, 26466026, 27554172, 27746027, 29199571, 7778693, 29064864, 29173780, 26387142,
      21049789, 28810141, 29101310, 28940132, 27503405, 27694023, 28698507, 26978621, 29173035, 28873026,
      28884566, 28978210, 29453550, 28146596, 28673788, 28365730, 28789497, 28571650, 29257397, 28009615,
      29243357, 412002, 29095062, 29095062, 29082956, 29206043, 28479126, 29133106, 28791463, 28957704,
      29207045, 27902438, 28757974, 28680329, 29282030, 22521181, 25994061, 28758157, 28504333, 27394673,
      28575266, 22833441, 29221365, 28505178, 28627042, 29261118, 28890939, 27908830, 29002793, 27424066,
      6226906, 10433947, 28829983, 28726218, 28891150, 28194983, 23671405, 28335012, 27769474, 28986139,
      29051067, 28748986, 7459647, 28705030, 28997781, 28649854, 29118805, 29404013, 29062252, 28671792,
      28973041, 29124058, 29042910, 29350955, 29304860, 29512189, 28315195, 28345088, 20115034, 26736235,
      25282622, 29308896, 525365, 28173025, 28254318, 29451338, 28047276, 28367697, 28320523, 27554172,
      29380628, 10570500, 29425666, 29412516, 26972771, 26387142, 21049789, 29440014, 28291821, 29113323,
      29126209, 29237370, 29126511, 29113963, 28230226, 29076792, 29101310, 28294287, 27057196, 27564974,
      28283036, 27903327, 29282954, 29027949, 29201695, 28300119, 29149957, 28849478, 29016210, 28932304,
      28932304, 29016869, 27636848, 26165832, 29203555, 28412712, 27583008, 28242006, 29165688, 28875202,
      29107677, 28773002, 28796245, 28417436, 29193406, 29180532, 29122142, 28421412, 28505040, 28891150,
      29073653, 29022646, 29010022, 28560127, 28765005, 28776208, 28868225, 28550925, 28973577, 28732399,
      28825485, 28802239, 28734672, 28723502, 28723502, 28563984, 28791463, 28691607, 28462288, 28737716,
      28771598, 28738516, 28738989, 28551399, 28820636, 29350623, 13929953, 27590218, 29494621, 29335961,
      28129285, 24835501, 27720003, 29432408, 29477107, 28477440, 29363709, 28653801, 29515925, 28950258,
      28857497, 29395855, 28750454, 29197882, 28788992, 29087929, 29280876, 29425666, 29373087, 29281103,
      28826633, 28940132, 29173780, 28689479, 28583723, 28963883, 29127291, 28989234, 28756511, 28802772,
      29237126, 29162235, 28860746, 29173780, 29201773, 28488726, 29200522, 28931638, 28791818, 29042702,
      28793664, 29130168, 28855878, 28771781, 28968096, 29230805, 24835501, 27672165, 29118805, 29083501,
      27989790, 28820636, 29057958, 981540, 29166128, 27535725, 9537331, 29192443, 9559847, 29273530,
      29121220, 9789245, 27415788, 25059086, 4689643, 29232754, 29181373, 27861097, 29182034, 26083385,
      28948598, 28422497, 28422829, 29171041, 26384945, 10570500, 20798779, 10760376, 26973821, 28144222,
      27692996, 27694023, 27561537, 27563983, 28065996, 27566505, 28115223, 19982580, 27546988, 28302167,
    ]
  end

  defp convert(api_key) do
    Enum.map(ids, fn id ->
      fetch_and_encode(id, api_key)
    end)
  end

  defp fetch_and_encode(id, api_key) do
    case GreenhouseIo.fetch(id, api_key) do
      {:ok, body} ->
        case Poison.decode(body) do
          {:ok, decoded_body} ->
            loop_emails(decoded_body["emails"], id, 1)
          {:error, error} ->
            IO.puts "Error decoding response body: #{error}"
        end
      {:error, error} ->
        IO.puts "Error fetching data: #{error}"
    end
  end

  defp loop_emails([], _, _), do: []
  defp loop_emails([email | emails], id, index) do
    [ build_email(email, id, index) | loop_emails(emails, id, index + 1)]
  end
end
