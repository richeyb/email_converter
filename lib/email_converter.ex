defmodule EmailConverter do
  import EmailConverter.EmailWrapper, only: [build_email: 3]
  alias EmailConverter.GreenhouseIo

  def run do
    Application.ensure_all_started(:email_converter)
    Application.get_env(:email_converter, :api_key)
    |> convert()
  end

  # PRIVATE FUNCTIONS

  defp ids do
    [
      29474834, 29320204, 29416203, 29362817, 29241914, 29284803, 29217293, 28215223, 28652220, 29458632,
      29409096, 29393394, 29230142, 29498463, 29394570, 29493646, 28731314, 29379175, 28560127, 28653750,
      28653801, 29379663, 28721035, 29340184, 29340985, 29350955, 29247442, 28542201, 28744267, 29327218,
      28425812, 29367547, 28369564, 29269485, 29249213, 28851178, 29044666, 28957092, 28957092, 28839349,
      28900428, 28935029, 28816985, 29059394, 29181236, 29097394, 29009423, 28891150, 28891150, 29195359,
      28855973, 28926648, 29170181, 28415114, 27924159, 9536759, 25847902, 28683877, 27989984, 28131500,
      28315195, 26083385, 26285516, 27219230, 28559719,
      24641629, 27998584, 25524030, 28550240, 27731659, 28179779, 27743232, 7483533, 28710131, 28575266,
      21049789, 27504364, 3370940, 28369056, 28453415, 28552199, 27560569,
      28365730, 28688399, 28107923, 27902647, 28756045, 27838111, 28188184, 28118623, 28119399, 27767316,
      12283627, 9063629, 9145208, 27769474, 26167255, 28333756, 27770345, 28704437, 27585274, 28693185,
      27716019, 28748891, 12825966, 29236478, 28582362, 28160482, 28577016, 29471165, 28772321, 28493657,
      28857209, 29197410, 29226616, 28950408, 29333370, 29306915, 29114045, 28785404, 29392197, 29408547,
      29126895, 29027088, 28930350, 28930350, 29230805, 28787204, 29288781, 29149288, 28860746, 29175499,
      29079489, 29232754, 29380628, 29042910, 29042969, 29029293, 29016679, 29105410, 29117763, 28813499,
      29383498, 28734566, 28185806, 28327580, 28231282, 28768579, 28231892, 28691131, 28680329, 28252447,
      28336564, 29375188, 29075638, 29211131, 28974234, 29448188, 29471935, 29025216, 28963198, 29126718,
      28822321, 29389265, 29147954, 29268830, 29320208, 29282023, 28859795, 29284803, 29463675, 29357351,
      29458632, 29014508, 29336634, 29175441, 29129316, 29426426, 28800057, 28849773, 29092344, 28932304,
      29004755, 29151482, 29203555, 29365289, 29117781, 29177173, 28992879, 29382287, 29237370, 29230252,
      9469819, 29107677, 29019400, 27672165, 24863952, 26273123, 26273123, 27930068, 28958401, 6970404,
      25059086, 25059086, 29021325, 25467200, 26285516, 29035153, 27998584, 29035346, 29234483, 26749861,
      29010490, 29062252, 29062252, 28949503, 28949579, 14473675, 27748298, 21049789, 28673047, 25898689,
      28683423, 28311404, 28278954, 28422829, 28568678, 28785404, 28314427, 15588287, 27902438, 27902647,
      28569244, 28652490, 28249657, 28065996, 27459655, 27839388, 22809192, 22811453, 27908830, 28653801,
      28118324, 26560656, 10376316,
      28119399, 28119399, 28765881, 28765881, 28744267, 12512424, 28425812, 25764037, 28289619, 9314807,
      29329210, 28482562, 28734454, 28815427, 28815427, 29107093, 29154240, 28853288, 29193322,
      29096198, 29155025, 29096322, 29096853, 29097251, 29247442, 28973577, 28127216, 28661133, 28547941,
      6958524, 27989984, 13381156, 28248657, 9974700, 26437871, 28422779, 26285516, 24640408, 28631694,
      28157185, 27729301, 27424066, 28569244,
      27608787, 27554172, 4926073, 28743238, 28571650, 7736162, 21049789, 28765881, 28644797, 27692996,
      28499496, 28744267, 28699870, 11098740, 27694023,
      28688152, 26978621, 27560569, 28365734, 8255674, 27561676, 28107923, 28228687, 22410245, 28734922,
      25434438, 27460156, 28735215, 16128592, 28502732, 28668520, 19982580, 6016802, 28691131, 28192838,
      27764834, 27398361, 28119399, 10433947, 28080907, 25864976, 28465091, 28715423, 28638666, 24428063,
      26016732, 28771598, 27667546, 28738886, 29453508, 28716663, 29280876, 29382998, 28716971, 29161967,
      29210873, 29102819, 29490576, 28974250, 29112950, 29184326, 29425666, 29076457, 28963138, 29268948,
      29147367, 29160399, 29147883, 28963883, 29358916, 29238653, 29257397, 29393701, 29362817, 28953553,
      29461828, 28811232, 29201587, 29445133, 29028698, 29457557, 28943060, 29397253, 29029293, 29502943,
      29389727, 29043282, 29511672, 29151620, 28767256, 28284904, 28326031, 28459018, 28544214, 28564218,
      28488726, 28575266, 28267883, 28770283, 28794213, 28771598, 28438943, 28567053, 29051231, 29012187,
      24865780, 29012630, 28033625, 13338399, 29225329, 25059086, 28940132, 29013116, 26189494, 26890637,
      29064864, 29147883, 29238681, 29200075, 25322400, 27545666, 28834811, 28178055, 27422399, 27547297,
      28044546, 29162235, 29079290, 29003689, 29202110, 28942688, 27610721, 29202327, 28991451, 20906768,
      27692996, 27454614, 29069226, 29257361, 28107923, 22162697, 29106691, 28863641, 29107140, 20381598,
      27458468, 29153351, 29230805, 29192307, 19982580, 6016802, 29179928, 22862942, 29194563, 29181373,
      29181373, 28829983, 29085156, 28197258, 28948296,
      28972196, 28160482, 24445703, 27714956, 12685023, 28926942, 29380195, 28961645, 28441952, 29403014,
      28784476, 29470495, 29404093, 29334148, 28314892, 28785631, 29454196, 29516770, 29403097, 29469852,
      29376093, 29351358, 29516570, 28786461, 28560127, 28683877
    ]
  end

  defp convert(api_key) do
    Enum.map(ids, fn id ->
      fetch_and_encode(id, api_key)
    end)
  end

  defp fetch_and_encode(id, api_key) do
    case GreenhouseIo.fetch(id, api_key) do
      {:ok, body} ->
        case Poison.decode(body) do
          {:ok, decoded_body} ->
            loop_emails(decoded_body["emails"], id, 1)
          {:error, error} ->
            IO.puts "Error decoding response body: #{error}"
        end
      {:error, error} ->
        IO.puts "Error fetching data: #{error}"
    end
  end

  defp loop_emails([], _, _), do: []
  defp loop_emails([email | emails], id, index) do
    [ build_email(email, id, index) | loop_emails(emails, id, index + 1)]
  end
end
